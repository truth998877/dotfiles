#!/bin/bash

set -euo pipefail

TOOLS="/opt/tools/bin"
PROXY_LIST="/opt/tools/proxies.txt"

if [[ ! -f "$PROXY_LIST" ]]; then
    echo "[!] No proxy list found at $PROXY_LIST"
    echo "Create it with one proxy per line, e.g. http://user:pass@ip:port"
    exit 1
fi

###############################################################################
# Proxy Selection
###############################################################################
choose_proxy_mode() {
    echo ""
    echo "Proxy mode:"
    echo " 1) No proxy"
    echo " 2) Use one random proxy for entire workflow"
    echo " 3) Rotate proxies for each tool"
    read -rp "Choose: " choice
    echo "$choice"
}

get_random_proxy() {
    shuf -n 1 "$PROXY_LIST"
}

###############################################################################
# Apply proxy to commands
###############################################################################
run_with_proxy() {
    local proxy="$1"
    shift

    if [[ -z "$proxy" ]]; then
        "$@"
    else
        http_proxy="$proxy" https_proxy="$proxy" "$@"
    fi
}

###############################################################################
# Workflow Steps
###############################################################################
subdomain_enum() {
    local domain="$1"
    local proxy="$2"

    # subfinder
    local subdomains="$(run_with_proxy "$proxy" subfinder -silent -d "$domain")"

    # append results from shuffledns
    local subdomains="$subdomains"\n"$(run_with_proxy "$proxy" shuffledns -d "$domain" -w worklist.txt -r resolvers.txt -mode bruteforce)"

    # add alterx results
		local subdomains="$subdomains"\n"$(run with proxy "$proxy" alterx -l "${subdomains/$'\n'/\,}" -enrich)"

#    if [ -z proxy ]; then
#		  subdomains="$(subfinder -silent -d "$domain)"
#
#    else
#      subdomains="$(subfinder -silent -d "$domain" -proxy "$proxy)"
#    fi
    
		#run_with_proxy "$proxy" "$TOOLS/assetfinder" --subs-only "$domain"
    
		#run_with_proxy "$proxy" "$TOOLS/crtsh" "$domain"

    # retain unique subdomains only
    subdomains="$(sort -u $subdomains)"
		
    # function output
		echo "$subdomains"
}

resolve_alive() {
    local proxy="$1"
		local subs="$2"

    # filter to resolvable domains
    #run_with_proxy "$proxy" xargs -I{} dig +short {} | sed 's/[[:space:]].*//g'
 
    sub_domains_alive="$(run_with_proxy dnsx "${subs/$'\n'/\,}")"

		echo "$sub_domains_alive"
}

http_probe() {
    local proxy="$1"
		local subs="$2"
    run_with_proxy "$proxy" httpx -silent -follow-redirects -status-code -title -tech-detect
}

port_scan() {
    local proxy="$1"
		local subs_filename="$2"

		local subs="$(<"$subs_filename")"

    #scan the top 100 ports using naabu
    run_with_proxy "$proxy" naabu -host ${subs/$'\n'/\,}-silent -top-ports 100 -ep 22
}

fetch_urls() {
    local proxy="$1"
		local DOMAIN="$2"
    run_with_proxy "$proxy" gau
    run_with_proxy "$proxy" waybackurls
}

crawl() {
    local proxy="$1"
		local subs="$2"
    run_with_proxy "$proxy" katana -silent -jc -kf
}

scan_vulns() {
    local proxy="$1"
		local subs="$2"
    run_with_proxy "$proxy" "nuclei" -silent -severity low,medium,high,critical
}

###############################################################################
# Main Driver
###############################################################################

mode="$1"
scantype_in="${2:-new}"

case "$mode" in
	none)
    PROXY=""
    ;;
  
	fixed)
    # use one of the proxies
    PROXY="$(get_random_proxy)"
    echo "[*] Selected proxy: $PROXY"
    ;;
  
	rotate)
    # use a different proxy for each of the tools
    PROXY="rotate"
    ;;
  *)
	echo "Invalid proxy setting (arg 1) - [none|fixed|rotate]"
  exit 1
esac

case "$scantype_in"
	newonly)
	  scantype="newonly"
		;;
  
	full)
	  scantpye="full"
    rm "$recon_output_dir/$domain/http.txt"
    rm "$recon_output_dir/$domain/ports.txt"
    rm "$recon_output_dir/$domain/urls.txt"
    rm "$recon_output_dir/$domain/crawl.txt"
    rm "$recon_output_dir/$domain/nuclei.txt"
		;;
  
	*)
	  echo "invalid scan type (arg 3 - [newonly|full])"
esac

recon_output_dir=$HOME/recon_output

if [ -d $HOME/recon_output ]; then
  mkdir -p $recon_output_dir
fi

#parse domains list

OLDIFS="$IFS"
IFS=$'/n'
domains=($(<domains.list))
IFS="$OLDIFS"

if [[ -z "$domains" ]]; then
    echo "domains.list not found"
    exit 1
fi

rotate_or_fixed() {
    if [[ "$PROXY" == "rotate" ]]; then
        get_random_proxy
    else
        echo "$PROXY"
    fi
}

#loop through each domain in domains.list
for i in "${domains[@]}";do

  domain="${domains[i]}"

  echo "[*] Starting recon workflow on: $domain"
  
	###############################################################################
  # 0. Set up Output directory for domain
  ###############################################################################
  
	if [ -d $recon_output_dir/$domain ]; then
    mkdir -p $recon_output_dir/$domain
  fi

  ###############################################################################
  # 1. Subdomain enumeration
  ###############################################################################
  
	echo "[*] Subdomain enumeration..."
  sub_domains_found="$(subdomain_enum "$domain" "$(rotate_or_fixed)")"
  
  ###############################################################################
  # 2. Resolve alive domains
  ###############################################################################
  
	echo "[*] Resolving alive hosts..."
  resolve_alive "$(rotate_or_fixed)" "$sub_domains_found" > $recon_output_dir/$domain/alive_now.txt

  ###############################################################################
  # 2.5 Only Continue with newly found subs if scan type is newonly
  ###############################################################################

  if [[ $scantype == newonly ]];then
	  new_alive_sub_domains="$(comm -3 $recon_output_dir/$domain/alice_old.txt $recon_output_dir/$domain/alive_now.txt)"

	  if [ -z $new_alive_sub_domains ];then
      echo "No new alive subdomains found for $domain"
      continue
    else
	    mv $recon_output_dir/$domain/alive_now.txt $recon_output_dir/$domain/alive_old.txt
		  echo "$new_alive_sub_domains" > $recon_output_dir/$domain/alive.txt
      
      #
			#TODO notify new subdomains have been found for $domain
      #
			
    fi
  
  else #$scantype=full
      mv $recon_output_dir/$domain/alive_now.txt $recon_output_dir/$domain/alive.txt
	fi
  
  ###############################################################################
  # 3. HTTP probing
  ###############################################################################
  
	#echo "[*] HTTP probing..."
  #http_probe "$(rotate_or_fixed)" $recon_output_dir/$domain/alive.txt > $recon_output_dir/$domain/http.txt
  
  ###############################################################################
  # 4. Port scanning
  ###############################################################################
  
	echo "[*] Port scanning..."
  port_scan "$(rotate_or_fixed)" "$recon_output_dir/$domain/alive.txt" >> "$recon_output_dir/$domain/ports.txt"
  
  ###############################################################################
  # 5. URL collection (gau + wayback)
  ###############################################################################
  
	echo "[*] Collecting URLs..."
  fetch_urls "$(rotate_or_fixed)" $domain >> urls.txt
  
  ###############################################################################
  # 6. Crawling (katana)
  ###############################################################################
  
	echo "[*] Crawling with katana..."
  crawl "$(rotate_or_fixed)" "$(<http.txt|awk '{print $1}')" >> crawl.txt
  
  ###############################################################################
  # 7. Nuclei scanning
  ###############################################################################
  
	echo "[*] Running nuclei..."
  scan_vulns "$(rotate_or_fixed)" "$(<http.txt | awk '{print $1}')" >> nuclei.txt
 
  ###############################################################################
  # 8. Notifications etc...
  ###############################################################################
  
  ###############################################################################
  # 9. Complete
  ###############################################################################

	echo ""
  echo "[*] Workflow complete for $domain."
  echo "Files generated/appended:"
  echo "  $recon_output_dir/$domain/alive.txt"
  echo "  $recon_output_dir/$domain/alive_old.txt"
  echo "  $recon_output_dir/$domain/http.txt"
  echo "  $recon_output_dir/$domain/ports.txt"
  echo "  $recon_output_dir/$domain/urls.txt"
  echo "  $recon_output_dir/$domain/crawl.txt"
  echo "  $recon_output_dir/$domain/nuclei.txt"

done

echo "All Domains completed"
echo $domains" 
