#!/bin/bash

if [[ ! -d "$HOME"/buglab/images ]]; then
  mkdir -p "$HOME"/buglab/images


echo -e "Getting images...\n"

 curl -L -o "$HOME"/buglab/images/ubuntu-24.04-server-cloudimg-amd64.img \
  https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img

 curl -L -o "$HOME"/buglab/images/kali-2024-cloudimg-amd64.img \
  https://images.kali.org/current/kali-linux-2024.1-cloud-amd64.qcow2


fi

discsizes=(40 40 40 20 20 40 40 80 20 60 20)
ramsizes=(8 4 3 2 2 1 2 4 2 4 1)
numcpus=(4 2 2 1 1 1 2 2 1 2 1)


username=tony
sshkey=$(<~/.ssh/id_ed25519.pub)

machines=( \
"kaliattacker"  \
"ansible"  \
"webvulnphp"  \
"juiceshop"  \
"webgoat"  \
"minio"  \
"localstack"  \
"k3s"  \
"legacy"  \
"opensearch"  \
"mail"  \
)


declare -A yaml_files

yaml_files["${machines[0]}"]=$(cat << EOF 
#cloud-config
hostname: kali-attacker
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - wget
  - curl
  - git
  - python3
  - python3-pip
  - net-tools

write_files:
  - path: /usr/local/bin/install-kali-tools.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y
      apt-get install -y kali-linux-default nmap ffuf gobuster amass sqlmap
      echo "Kali tools installed"

runcmd:
  - [ sh, -c, "/usr/local/bin/install-kali-tools.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for kali-attacker' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[1]}"]=$(cat << EOF 
#cloud-config
hostname: ansible
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - python3
  - python3-venv
  - python3-pip
  - git
  - curl

write_files:
  - path: /usr/local/bin/bootstrap-ansible.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y
      apt-get install -y python3-venv python3-pip git
      python3 -m venv /home/USERNAME_PLACEHOLDER/ansible-venv
      /home/USERNAME_PLACEHOLDER/ansible-venv/bin/pip install --upgrade pip ansible
      chown -R USERNAME_PLACEHOLDER:USERNAME_PLACEHOLDER /home/USERNAME_PLACEHOLDER
      echo "Ansible bootstrapped"

runcmd:
  - [ sh, -c, "/usr/local/bin/bootstrap-ansible.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for ansible' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[2]}"]=$(cat << EOF 
#cloud-config
hostname: web-vuln-php
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - docker.io
  - docker-compose

write_files:
  - path: /opt/vuln/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3'
      services:
        dvwa:
          image: vulnerables/web-dvwa:latest
          ports:
            - "80:80"
          restart: always
        bwapp:
          image: raesene/bwapp
          ports:
            - "8080:80"
          restart: always

  - path: /usr/local/bin/provision-web-vuln.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      mkdir -p /opt/vuln
      cd /opt/vuln
      cat > docker-compose.yml <<'EOF'
      version: '3'
      services:
        dvwa:
          image: vulnerables/web-dvwa
          ports:
            - "80:80"
          restart: always
        bwapp:
          image: raesene/bwapp
          ports:
            - "8080:80"
          restart: always
      EOF
      docker-compose up -d || true
      echo "DVWA and bWAPP started"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-web-vuln.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for web-vuln-php' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[3]}"]=$(cat << EOF 
#cloud-config
hostname: juice-shop
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - curl
  - docker.io

write_files:
  - path: /usr/local/bin/provision-juice.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      docker pull bkimminich/juice-shop:latest || true
      docker run -d --name juice-shop -p 3000:3000 bkimminich/juice-shop || true
      echo "Juice Shop running on port 3000"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-juice.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for juice-shop' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[4]}"]=$(cat << EOF 
#cloud-config
hostname: webgoat
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - default-jre
  - docker.io

write_files:
  - path: /usr/local/bin/provision-webgoat.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      docker pull webgoat/webgoat-8.0 || true
      docker run -d --name webgoat -p 8080:8080 webgoat/webgoat-8.0 || true
      echo "WebGoat running on port 8080"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-webgoat.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for webgoat' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[5]}"]=$(cat << EOF 
#cloud-config
hostname: minio
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
packages:
  - docker.io

write_files:
  - path: /usr/local/bin/provision-minio.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      docker pull minio/minio:latest || true
      mkdir -p /data/minio
      docker run -d --name minio -p 9000:9000 -p 9001:9001 \
        -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin \
        -v /data/minio:/data minio/minio:latest server /data --console-address ":9001" || true
      echo "MinIO running on ports 9000 (API) and 9001 (console)"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-minio.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for minio' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[6]}"]=$(cat << EOF 
#cloud-config
hostname: localstack
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
packages:
  - docker.io
  - python3-pip

write_files:
  - path: /usr/local/bin/provision-localstack.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      docker pull localstack/localstack:latest || true
      docker run -d --name localstack -p 4566:4566 -p 4571:4571 localstack/localstack || true
      echo "LocalStack running on port 4566 (edge)"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-localstack.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for localstack' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[7]}"]=$(cat << EOF 
#cloud-config
hostname: k3s
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
packages:
  - curl

write_files:
  - path: /usr/local/bin/provision-k3s.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644 || true
      # kubectl available at /usr/local/bin/kubectl
      echo "k3s installed (single-node)."

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-k3s.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for k3s' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[8]}"]=$(cat << EOF 
#cloud-config
hostname: legacy
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
package_upgrade: true
packages:
  - net-tools
  - wget
  - curl

write_files:
  - path: /usr/local/bin/provision-legacy-note.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      echo "This VM is prepared as a legacy target. For an authentically vulnerable system consider importing Metasploitable2 or installing old packages manually." > /var/log/legacy-note.txt

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-legacy-note.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for legacy (note only)' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[9]}"]=$(cat << EOF 
#cloud-config
hostname: opensearch
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
packages:
  - docker.io
  - docker-compose

write_files:
  - path: /opt/opensearch/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3'
      services:
        opensearch:
          image: opensearchproject/opensearch:2.10.0
          environment:
            - "discovery.type=single-node"
            - "plugins.security.disabled=true"
          ulimits:
            memlock:
              soft: -1
              hard: -1
          ports:
            - "9200:9200"
            - "9600:9600"
          volumes:
            - opensearch-data:/usr/share/opensearch/data
      volumes:
        opensearch-data:

  - path: /usr/local/bin/provision-opensearch.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      mkdir -p /opt/opensearch
      cat > /opt/opensearch/docker-compose.yml <<'EOF'
      version: '3'
      services:
        opensearch:
          image: opensearchproject/opensearch:2.10.0
          environment:
            - "discovery.type=single-node"
            - "plugins.security.disabled=true"
          ulimits:
            memlock:
              soft: -1
              hard: -1
          ports:
            - "9200:9200"
            - "9600:9600"
          volumes:
            - opensearch-data:/usr/share/opensearch/data
      volumes:
        opensearch-data:
      EOF
      apt-get update -y || true
      apt-get install -y docker-compose || true
      docker-compose -f /opt/opensearch/docker-compose.yml up -d || true
      echo "OpenSearch started"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-opensearch.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for opensearch' >> /var/log/provision.log" ]


EOF
)


yaml_files["${machines[10]}"]=$(cat << EOF 
#cloud-config
hostname: mail
users:
  - name: USERNAME_PLACEHOLDER
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - SSHKEY_PLACEHOLDER

package_update: true
packages:
  - docker.io

write_files:
  - path: /usr/local/bin/provision-mailhog.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      systemctl enable --now docker || true
      docker pull mailhog/mailhog:latest || true
      docker run -d --name mailhog -p 1025:1025 -p 8025:8025 mailhog/mailhog || true
      echo "MailHog running: SMTP 1025, Web UI 8025"

runcmd:
  - [ sh, -c, "/usr/local/bin/provision-mailhog.sh >> /var/log/provision.log 2>&1 || true" ]
  - [ sh, -c, "echo 'Provisioning complete for mail (MailHog)' >> /var/log/provision.log" ]


EOF
)


img_dir="/var/lib/libvirt/images"
index=0
if [ ! -d $HOME/buglab/cloudinit ]; then
  mkdir -p $HOME/buglab/cloudinit
fi

for machine in "${machines[@]}";do

  cd $HOME/buglab/cloudinit

# echo "${yaml_files["$machine"]}"
	echo "${yaml_files["$machine"]}" > "$machine.yml"
  cloud-localds "$machine"-seed.iso "$machine.yml"
	rm "$machine.yml"

	cd -

	if [[ "$index" == 0 ]]; then
    image="$HOME/buglab/images/kali-2024-cloudimg-amd64.img"
	else
    image="$HOME/buglab/images/ubuntu-24.04-server-cloudimg-amd64.img"
	fi
	
  sudo qemu-img create -f qcow2 -b "$image" \
          "$img_dir"/"$machine".qcow2 "${discsizes[$index]}"G

  sudo virt-install \
  --name $machine \
  --memory "${ramsizes[$index]}" \
  --vcpus "${numcpus[$index]}" \
  --disk path="$img_dir"/"$machine".qcow2,format=qcow2 \
  --disk path="$HOME"/buglab/cloudinit/"$machine"-seed.iso,device=cdrom \
  --os-variant debian12 \
  --network network=lab-net,mac=52:54:00:ab:cd:"$((index+10))" \
  --import \
  --graphics none \
  --noautoconsole
	
	((index++))

done
